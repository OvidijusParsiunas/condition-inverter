name: push to main branch
on:
  push:
    branches:
      - main

jobs:
  build-and-test-extension:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      NODE_ENV: development
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Install and Test extension/inverter ğŸ”§
        run: |
          npm install
          npm run compile
        working-directory: ./extension
      - name: Run headless test ğŸ”§
        uses: GabrielBB/xvfb-action@v1.0
        with:
          run: npm --prefix ./extension run test:coverage
      - name: Deploy coverage ğŸš€
        uses: codecov/codecov-action@v2
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: true # (default = false)
          verbose: true # (default = false)
          version: 'v0.1.15'
      - name: Prepare config for Testspace ğŸ”§
        uses: testspace-com/setup-testspace@v1
        with:
          domain: ${{ github.repository_owner }}
      - name: Publish results to Testspace ğŸš€
        run: testspace "[${{ github.workflow }} / ${{ matrix.os}}]./testspace/xunit.xml"

  build-and-deploy-website:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: development
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Install and Build Wesbite ğŸ”§
        run: |
          npm install
          npm run compile
          npm run build
        working-directory: ./website
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: website/build # The folder the action should deploy from (source branch).
    needs: build-and-test-extension # Wait for the build-and-test-extension to succeed
